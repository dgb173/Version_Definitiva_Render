{% set active_section = page_mode or 'upcoming' %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|default('Partidos', true) }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color:#f5f6fb; font-family:'Inter',system-ui,'Segoe UI',sans-serif; color:#1f2330; }
        .app-shell { display:flex; min-height:100vh; position:relative; }
        .sidebar {
            width:360px;
            background:#fff;
            border-right:1px solid #e3e6ef;
            padding:24px;
            height:100vh;
            overflow-y:auto;
            position:sticky;
            top:0;
            flex-shrink:0;
            transition:transform .3s ease, box-shadow .3s ease;
            z-index:5;
        }
        .app-shell.sidebar-collapsed .sidebar { transform:translateX(-100%); box-shadow:none; }
        .sidebar-backdrop { display:none; }
        .detail-panel { flex:1; padding:56px 48px 48px; overflow-y:auto; position:relative; transition:padding .3s ease; }
        .sidebar-toggle {
            position:absolute;
            top:18px;
            left:18px;
            border:none;
            border-radius:999px;
            background:#fff;
            box-shadow:0 10px 25px rgba(15,23,42,0.08);
            padding:8px 16px;
            display:flex;
            align-items:center;
            gap:8px;
            font-weight:600;
            color:#1f2330;
            cursor:pointer;
            z-index:6;
        }
        .sidebar-toggle i { color:#4c6ef5; transition:transform .2s ease; }
        .app-shell.sidebar-collapsed .sidebar-toggle i { transform:rotate(180deg); }
        .sidebar-toggle span { font-size:0.85rem; }
        .view-switch { display:flex; gap:10px; margin-bottom:16px; }
        .view-toggle { flex:1; border:1px solid #d5dbf8; border-radius:999px; background:#f5f8ff; font-weight:600; padding:8px 14px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:all .2s; }
        .view-toggle.active { background:#4c6ef5; color:#fff; border-color:#4c6ef5; }
        .view-toggle .badge { background:rgba(255,255,255,0.2); }
        .filters-form label { font-size:0.85rem; font-weight:600; }
        .match-lists { margin-top:24px; }
        .match-list { display:none; }
        .match-list.is-active { display:block; }
        .match-card { border:1px solid #e3e6ef; border-left:4px solid #c7d7ff; border-radius:10px; padding:12px 14px; margin-bottom:12px; background:#fff; transition:border-color .2s, background .2s; cursor:pointer; }
        .match-card.is-active { border-color:#4c6ef5; background:#f5f8ff; }
        .match-card .match-time { font-size:0.85rem; color:#64708a; margin-bottom:4px; }
        .match-card .competition { font-size:0.8rem; color:#8a94af; margin-bottom:6px; }
        .match-card .badge { font-size:0.75rem; border-radius:999px; padding:4px 10px; }
        .home-color { color:#2563eb; font-weight:700; }
        .away-color { color:#f97316; font-weight:700; }
        .score-value { font-weight:700; color:#16a34a; }
        .ah-value { font-weight:600; color:#6f42c1; }
        .data-highlight { color:#dc2626; font-weight:600; }
        .badge-handicap { background:#edf2ff; color:#3b5bdb; }
        .badge-goal { background:#e6fcf5; color:#099268; }
        .score-pill { font-weight:700; color:#198754; }
        .match-card-meta { display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .match-actions { display:flex; gap:8px; }
        .match-action { border:none; background:#eff1fb; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .2s; }
        .match-action:hover { background:#4c6ef5; color:#fff; }
        .detail-panel-content { max-width:1000px; margin:0 auto; }
        .panel-card { background:#fff; border:1px solid #e3e6ef; border-radius:16px; padding:24px; box-shadow:0 6px 20px rgba(15,23,42,0.06); }
        .panel-analysis { margin-top:24px; }
        .panel-placeholder { text-align:center; padding:60px 20px; border:1px dashed #ced4f2; border-radius:12px; background:#fff; }
        .panel-loading { display:flex; align-items:center; justify-content:center; gap:10px; font-weight:600; }
        .quick-preview .panel-card-header h2 { font-size:1.4rem; }
        .preview-tabs { display:flex; gap:10px; margin-top:12px; }
        .preview-tab { flex:1; border:1px solid #e0e6ff; background:#f7f8ff; color:#1f2330; font-weight:600; border-radius:999px; padding:8px 14px; cursor:pointer; transition:all .2s; }
        .preview-tab.active { background:#4c6ef5; color:#fff; border-color:#4c6ef5; }
        .quick-preview-panel { display:none; margin-top:20px; }
        .quick-preview-panel.is-active { display:block; }
        .preview-section { margin-bottom:24px; }
        .section-head { font-weight:700; color:#1f2330; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .recent-columns { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
        .recent-column { background:#fff; border:1px solid #edf0ff; border-radius:14px; padding:14px; }
        .recent-column-head { font-size:0.9rem; color:#4c6ef5; font-weight:600; margin-bottom:10px; display:flex; flex-direction:column; }
        .mini-match { border:1px solid #ecefff; border-radius:12px; padding:12px; background:#fdfdff; margin-bottom:10px; }
        .mini-match:last-child { margin-bottom:0; }
        .mini-match-meta { display:flex; align-items:center; gap:8px; font-size:0.78rem; color:#64708a; flex-wrap:wrap; margin-bottom:6px; }
        .result-pill { width:24px; height:24px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.75rem; }
        .mini-match.is-win .result-pill { background:#d1fae5; color:#0f766e; }
        .mini-match.is-loss .result-pill { background:#fee2e2; color:#b91c1c; }
        .mini-match.is-draw .result-pill { background:#e2e8f0; color:#475569; }
        .mini-match-teams { display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:600; }
        .team-chip { flex:1; font-size:0.9rem; color:#475569; }
        .team-chip.is-focus { color:#111827; font-weight:700; }
        .score-chip { font-weight:700; color:#111827; min-width:58px; text-align:center; }
        .mini-match-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; font-size:0.75rem; }
        .handicap-chip { background:#edf2ff; color:#3b5bdb; border-radius:999px; padding:2px 10px; font-weight:600; }
        .role-chip { background:#fff5f5; color:#c2410c; border-radius:999px; padding:2px 10px; font-weight:600; }
        .future-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
        .future-card { border:1px solid #e6ebff; border-radius:12px; padding:12px; background:#fff; }
        .future-card .future-head { display:flex; justify-content:space-between; font-size:0.8rem; color:#64708a; margin-bottom:6px; }
        .future-card .future-teams { display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:600; }
        .comparatives-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
        .comparative-card { border:1px solid #e5e7f8; border-radius:14px; padding:16px; background:#fafbff; }
        .comparative-rival { font-weight:700; color:#1f2330; margin-bottom:8px; }
        .comparative-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:0.85rem; margin-top:8px; }
        .comparative-row .result-pill { width:26px; height:26px; }
        .comparative-row .handicap-chip { background:#fff; border:1px solid #dfe3ff; }
        @media (max-width: 992px) {
            .app-shell { flex-direction:column; }
            .sidebar {
                position:fixed;
                left:0;
                top:0;
                height:100vh;
                width:min(360px,88vw);
                border-right:none;
                border-bottom:1px solid #e3e6ef;
                box-shadow:0 20px 45px rgba(15,23,42,0.25);
                background:#fff;
            }
            .sidebar-backdrop {
                display:block;
                position:fixed;
                inset:0;
                background:rgba(15,23,42,0.45);
                opacity:0;
                pointer-events:none;
                transition:opacity .3s ease;
                z-index:4;
            }
            .app-shell:not(.sidebar-collapsed) .sidebar-backdrop {
                opacity:1;
                pointer-events:auto;
            }
            .detail-panel { padding:72px 20px 40px; }
            .sidebar-toggle { top:12px; left:16px; }
        }
    </style>
</head>
<body>
    <div class="app-shell" data-active-list="{{ active_section }}">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="mb-2">{{ page_title|default('Partidos', true) }}</h1>
                <p class="text-muted">Selecciona un partido y usa los 칤conos 游녜 (vista r치pida) o 游늳 (an치lisis completo) sin salir de esta p치gina.</p>
                <div class="view-switch">
                    <button type="button" class="view-toggle {% if active_section != 'finished' %}active{% endif %}" data-target="upcoming">
                        Pr칩ximos
                        <span class="badge">{{ upcoming_matches|length if upcoming_matches else 0 }}</span>
                    </button>
                    <button type="button" class="view-toggle {% if active_section == 'finished' %}active{% endif %}" data-target="finished">
                        Finalizados
                        <span class="badge">{{ finished_matches|length if finished_matches else 0 }}</span>
                    </button>
                </div>
                <form class="filters-form" method="get">
                    <div class="mb-2">
                        <label for="handicap-filter" class="form-label">Filtro por h치ndicap</label>
                        <input list="handicap-options" type="text" class="form-control form-control-sm" id="handicap-filter" name="handicap" value="{{ handicap_filter|default('', true) }}" placeholder="Ej: 0, 0.25, 1">
                        <datalist id="handicap-options">
                            {% for opt in handicap_options %}
                            <option value="{{ opt }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="mb-3">
                        <label for="goal-line-filter" class="form-label">Filtro por l칤nea de goles</label>
                        <input list="goal-line-options" type="text" class="form-control form-control-sm" id="goal-line-filter" name="ou" value="{{ goal_line_filter|default('', true) }}" placeholder="Ej: 2.25, 2.5">
                        <datalist id="goal-line-options">
                            {% for opt in goal_line_options %}
                            <option value="{{ opt }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Aplicar filtros</button>
                        <a class="btn btn-outline-secondary btn-sm w-100" href="{{ request.path }}">Limpiar</a>
                    </div>
                </form>
                {% if error %}
                <div class="alert alert-warning mt-3 py-2 px-3">{{ error }}</div>
                {% endif %}
            </div>
            <div class="match-lists mt-3">
                <div class="match-list {% if active_section != 'finished' %}is-active{% endif %}" data-list="upcoming">
                    {% if upcoming_matches %}
                        {% for match in upcoming_matches %}
                            {% set card_id = match.id or match.match_id %}
                            {% if card_id %}
                                {% set competition = match.competition or match.league or match.league_name %}
                                {% set goal_value = match.goal_line or match.goal_line_alt or match.goal_line_decimal %}
                                <div class="match-card" data-match-id="{{ card_id }}" data-section="upcoming">
                                    <div class="match-time">{{ match.time or '-' }}</div>
                                    <div class="teams">{{ match.home_team or match.homeName }} vs {{ match.away_team or match.awayName }}</div>
                                    {% if competition %}<div class="competition">{{ competition }}</div>{% endif %}
                                    <div class="match-card-meta">
                                        <div class="odds">
                                            {% if match.handicap %}<span class="badge badge-handicap">AH {{ match.handicap }}</span>{% endif %}
                                            {% if goal_value %}<span class="badge badge-goal">O/U {{ goal_value }}</span>{% endif %}
                                        </div>
                                        <div class="match-actions">
                                            <button type="button" class="match-action" data-action="preview" aria-label="Vista r치pida"><i class="fa-solid fa-eye"></i></button>
                                            <button type="button" class="match-action" data-action="analysis" aria-label="An치lisis completo"><i class="fa-solid fa-chart-line"></i></button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small mb-0">No hay partidos pr칩ximos disponibles.</p>
                    {% endif %}
                </div>
                <div class="match-list {% if active_section == 'finished' %}is-active{% endif %}" data-list="finished">
                    {% if finished_matches %}
                        {% for match in finished_matches %}
                            {% set card_id = match.id or match.match_id %}
                            {% if card_id %}
                                {% set competition = match.competition or match.league or match.league_name %}
                                {% set goal_value = match.goal_line or match.goal_line_alt or match.goal_line_decimal %}
                                <div class="match-card" data-match-id="{{ card_id }}" data-section="finished">
                                    <div class="match-time">{{ match.time or '-' }}</div>
                                    <div class="teams">{{ match.home_team or match.homeName }} vs {{ match.away_team or match.awayName }}</div>
                                    {% if match.score %}<div class="score-pill">{{ match.score }}</div>{% endif %}
                                    {% if competition %}<div class="competition">{{ competition }}</div>{% endif %}
                                    <div class="match-card-meta">
                                        <div class="odds">
                                            {% if match.handicap %}<span class="badge badge-handicap">AH {{ match.handicap }}</span>{% endif %}
                                            {% if goal_value %}<span class="badge badge-goal">O/U {{ goal_value }}</span>{% endif %}
                                        </div>
                                        <div class="match-actions">
                                            <button type="button" class="match-action" data-action="preview" aria-label="Vista r치pida"><i class="fa-solid fa-eye"></i></button>
                                            <button type="button" class="match-action" data-action="analysis" aria-label="An치lisis completo"><i class="fa-solid fa-chart-line"></i></button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small mb-0">No hay partidos finalizados con los filtros actuales.</p>
                    {% endif %}
                </div>
            </div>
        </aside>
        <div class="sidebar-backdrop" aria-hidden="true"></div>
        <main class="detail-panel">
            <button type="button" class="sidebar-toggle" aria-label="Mostrar u ocultar la lista de partidos">
                <i class="fa-solid fa-chevron-left"></i>
                <span>Partidos</span>
            </button>
            <div id="detail-panel-content" class="detail-panel-content">
                <div class="panel-placeholder">
                    <h2>Selecciona un partido</h2>
                    <p>Haz clic en un partido y usa 游녜 o 游늳 para ver la informaci칩n aqu칤 mismo.</p>
                </div>
            </div>
        </main>
    </div>
        <script>
        (function () {
            const shell = document.querySelector('.app-shell');
            const detailPanel = document.getElementById('detail-panel-content');
            if (!shell || !detailPanel) return;
            const sidebarToggleBtn = document.querySelector('.sidebar-toggle');
            const sidebarBackdrop = document.querySelector('.sidebar-backdrop');

            const state = {
                activeList: shell.dataset.activeList || 'upcoming',
                activeMatch: null
            };

            const isMobileView = () => window.matchMedia('(max-width: 991px)').matches;

            const setSidebarCollapsed = (collapsed) => {
                shell.classList.toggle('sidebar-collapsed', collapsed);
                if (sidebarToggleBtn) {
                    sidebarToggleBtn.setAttribute('aria-expanded', (!collapsed).toString());
                }
            };

            setSidebarCollapsed(shell.classList.contains('sidebar-collapsed'));
            if (isMobileView()) {
                setSidebarCollapsed(true);
            }

            window.addEventListener('resize', () => {
                if (isMobileView()) {
                    setSidebarCollapsed(true);
                }
            });

            const autoCollapseSidebarForMobile = () => {
                if (isMobileView()) {
                    setSidebarCollapsed(true);
                }
            };

            const setDetailContent = (html) => {
                detailPanel.innerHTML = html;
                detailPanel.scrollTop = 0;
            };

            const showPlaceholder = (message) => {
                setDetailContent(`<div class="panel-placeholder"><p class="mb-0">${message}</p></div>`);
            };

            const formatDisplayTime = (value) => {
                if (!value) return '-';
                if (typeof value === 'string' && value.trim()) return value;
                try {
                    const date = new Date(value);
                    if (!Number.isNaN(date.getTime())) {
                        return date.toLocaleString('es-ES', { hour12: false });
                    }
                } catch (err) {
                    return '-';
                }
                return '-';
            };

            const safeArray = (value) => (Array.isArray(value) ? value : []);
            const formatHandicapText = (line) => (line && line !== '-') ? `AH ${line}` : 'AH -';

            const renderRecentMatch = (match) => {
                const result = (match.result || '').toUpperCase();
                let resultClass = 'is-draw';
                if (result === 'W') resultClass = 'is-win';
                if (result === 'L') resultClass = 'is-loss';
                return `
                    <div class="mini-match ${resultClass}">
                        <div class="mini-match-meta">
                            <span class="result-pill">${result || '-'}</span>
                            <span>${match.league || '-'}</span>
                            <span>${match.date || ''}</span>
                        </div>
                        <div class="mini-match-teams">
                            <span class="team-chip ${match.is_home ? 'is-focus' : ''}">${match.home_team || '-'}</span>
                            <span class="score-chip">${match.score || '-'}</span>
                            <span class="team-chip ${match.is_home ? '' : 'is-focus'}">${match.away_team || '-'}</span>
                        </div>
                        <div class="mini-match-tags">
                            <span class="handicap-chip">${formatHandicapText(match.handicap)}</span>
                            <span class="role-chip">${match.is_home ? 'Local' : 'Visitante'}</span>
                        </div>
                    </div>
                `;
            };

            const renderRecentColumn = (title, payload) => {
                const matches = safeArray((payload || {}).matches);
                const teamLabel = (payload && payload.team) || '';
                const body = matches.length
                    ? matches.map(renderRecentMatch).join('')
                    : '<p class="text-muted small mb-0">Sin datos recientes.</p>';
                return `
                    <div class="recent-column">
                        <div class="recent-column-head">
                            <span>${title}</span>
                            ${teamLabel ? `<small>${teamLabel}</small>` : ''}
                        </div>
                        ${body}
                    </div>
                `;
            };

            const renderFutureMatch = (match) => `
                <div class="future-card">
                    <div class="future-head">
                        <span>${match.league || '-'}</span>
                        <span>${match.date || ''}</span>
                    </div>
                    <div class="future-teams">
                        <span class="team-chip ${match.is_home ? 'is-focus' : ''}">${match.home_team || '-'}</span>
                        <span class="score-chip">vs</span>
                        <span class="team-chip ${match.is_home ? '' : 'is-focus'}">${match.away_team || '-'}</span>
                    </div>
                </div>
            `;

            const renderFutureColumn = (title, payload) => {
                const matches = safeArray((payload || {}).matches);
                const teamLabel = (payload && payload.team) || '';
                const body = matches.length
                    ? matches.map(renderFutureMatch).join('')
                    : '<p class="text-muted small mb-0">Sin partidos programados.</p>';
                return `
                    <div class="recent-column">
                        <div class="recent-column-head">
                            <span>${title}</span>
                            ${teamLabel ? `<small>${teamLabel}</small>` : ''}
                        </div>
                        ${body}
                    </div>
                `;
            };

            const renderComparativeRow = (match, label) => {
                if (!match) {
                    return `<p class="text-muted small mb-0">${label}: sin registro.</p>`;
                }
                const result = (match.result || '').toUpperCase();
                let resultClass = 'is-draw';
                if (result === 'W') resultClass = 'is-win';
                if (result === 'L') resultClass = 'is-loss';
                return `
                    <div class="comparative-row ${resultClass}">
                        <span class="result-pill">${result || '-'}</span>
                        <span class="team-chip ${match.is_home ? 'is-focus' : ''}">${match.home_team || '-'}</span>
                        <span class="score-chip">${match.score || '-'}</span>
                        <span class="team-chip ${match.is_home ? '' : 'is-focus'}">${match.away_team || '-'}</span>
                        <span class="handicap-chip">${formatHandicapText(match.handicap)}</span>
                    </div>
                `;
            };

            const renderComparativeCard = (item) => `
                <div class="comparative-card">
                    <div class="comparative-rival">Rival: ${item.rival || '-'}</div>
                    <div class="text-muted small">Equipo local</div>
                    ${renderComparativeRow(item.home_match, 'Equipo local')}
                    <div class="text-muted small mt-2">Equipo visitante</div>
                    ${renderComparativeRow(item.away_match, 'Equipo visitante')}
                </div>
            `;

            const renderComparativesSection = (comparisons) => {
                const items = safeArray(comparisons);
                if (!items.length) {
                    return '<p class="text-muted small mb-0">Sin comparativas disponibles.</p>';
                }
                return `<div class="comparatives-grid">${items.map(renderComparativeCard).join('')}</div>`;
            };

            const renderQuickPreview = (data) => {
                const goalLineValue = data.goal_line || data.goal_line_alt || data.goal_line_decimal;
                const handicap = data.handicap ? `<span class="badge badge-handicap me-2">AH ${data.handicap}</span>` : '';
                const goalLine = goalLineValue ? `<span class="badge badge-goal">O/U ${goalLineValue}</span>` : '';
                const statusLabel = data.section === 'finished_matches' ? 'Partido finalizado' : 'Pr칩ximo partido';
                const recentForm = data.recent_form || {};
                const upcoming = data.upcoming_matches || {};
                const comparisons = data.direct_comparisons || [];
                return `
                    <div class="panel-card quick-preview">
                        <div class="panel-card-header">
                            <h2>${data.home_team || '-'} vs ${data.away_team || '-'}</h2>
                            <p class="text-muted mb-1">${data.competition || ''}</p>
                            <p class="text-muted small mb-0">${statusLabel} 췅 ${formatDisplayTime(data.time || data.time_obj)}</p>
                        </div>
                        <div class="panel-analysis">
                            <div class="mb-3">${handicap}${goalLine}</div>
                            <div class="preview-tabs" role="tablist">
                                <button type="button" class="preview-tab active" data-preview-panel="form">Forma y pr칩ximos</button>
                                <button type="button" class="preview-tab" data-preview-panel="comparatives">Comparativas directas</button>
                            </div>
                            <div class="quick-preview-panel is-active" data-preview-panel="form">
                                <section class="preview-section">
                                    <div class="section-head">칔ltimos 5 partidos</div>
                                    <div class="recent-columns">
                                        ${renderRecentColumn('Equipo local', recentForm.home)}
                                        ${renderRecentColumn('Equipo visitante', recentForm.away)}
                                    </div>
                                </section>
                                <section class="preview-section">
                                    <div class="section-head">Pr칩ximos 3 partidos</div>
                                    <div class="future-grid">
                                        ${renderFutureColumn('Equipo local', upcoming.home)}
                                        ${renderFutureColumn('Equipo visitante', upcoming.away)}
                                    </div>
                                </section>
                            </div>
                            <div class="quick-preview-panel" data-preview-panel="comparatives">
                                ${renderComparativesSection(comparisons)}
                            </div>
                            <p class="text-muted mb-0"><small>Haz clic en &#128200; para ver el panel avanzado.</small></p>
                        </div>
                    </div>
                `;
            };

            const renderAnalysis = (payload) => {
                const elapsed = payload.meta && typeof payload.meta.elapsed !== 'undefined'
                    ? `Generado en ${payload.meta.elapsed}s`
                    : '';
                const score = payload.match && payload.match.score ? `<p class="score-pill">${payload.match.score}</p>` : '';
                return `
                    <div class="panel-card">
                        <div class="panel-card-header">
                            <h2>${(payload.match && payload.match.home) || '-'} vs ${(payload.match && payload.match.away) || '-'}</h2>
                            <p class="text-muted mb-1">${(payload.match && payload.match.time) || ''}</p>
                            ${score}
                            <p class="text-muted small mb-0">${elapsed}</p>
                        </div>
                        <div class="panel-analysis">
                            ${payload.html || '<p class="text-muted">No se pudo generar el an치lisis.</p>'}
                        </div>
                    </div>
                `;
            };

            const setActiveCard = (matchId) => {
                state.activeMatch = matchId;
                document.querySelectorAll('.match-card').forEach((card) => {
                    card.classList.toggle('is-active', card.dataset.matchId === matchId);
                });
            };

            const loadQuickPreview = (matchId, section) => {
                setDetailContent('<div class="panel-placeholder"><div class="panel-loading"><span class="spinner-border spinner-border-sm"></span> Preparando vista previa...</div></div>');
                fetch(`/api/preview_basico/${matchId}`)
                    .then((response) => {
                        if (!response.ok) throw new Error('No se encontr칩 informaci칩n r치pida para este partido.');
                        return response.json();
                    })
                    .then((data) => {
                        data.section = section === 'finished' ? 'finished_matches' : 'upcoming_matches';
                        setDetailContent(renderQuickPreview(data));
                    })
                    .catch((error) => showPlaceholder(error.message || 'No se pudo cargar la vista previa.'));
            };

            const loadFullAnalysis = (matchId) => {
                setDetailContent('<div class="panel-placeholder"><div class="panel-loading"><span class="spinner-border spinner-border-sm"></span> Generando an치lisis completo...</div></div>');
                fetch(`/api/estudio_panel/${matchId}`)
                    .then((response) => {
                        if (!response.ok) throw new Error('No se pudo renderizar el an치lisis.');
                        return response.json();
                    })
                    .then((payload) => {
                        if (payload.error) throw new Error(payload.error);
                        setDetailContent(renderAnalysis(payload));
                    })
                    .catch((error) => showPlaceholder(error.message || 'No se pudo cargar el an치lisis.'));
            };

            const autoSelectFirstCard = (listName) => {
                const list = document.querySelector(`.match-list[data-list="${listName}"]`);
                if (!list) return;
                const firstCard = list.querySelector('.match-card');
                if (!firstCard) {
                    showPlaceholder('No hay partidos disponibles para esta vista.');
                    state.activeMatch = null;
                    return;
                }
                const matchId = firstCard.dataset.matchId;
                setActiveCard(matchId);
                loadQuickPreview(matchId, listName);
            };

            const switchList = (target) => {
                if (!target || target === state.activeList) return;
                state.activeList = target;
                document.querySelectorAll('.view-toggle').forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.target === target);
                });
                document.querySelectorAll('.match-list').forEach((list) => {
                    list.classList.toggle('is-active', list.dataset.list === target);
                });
                autoSelectFirstCard(target);
            };

            const activatePreviewPanel = (tab) => {
                const card = tab.closest('.quick-preview');
                if (!card) return;
                const targetPanel = tab.dataset.previewPanel;
                card.querySelectorAll('.preview-tab').forEach((btn) => {
                    btn.classList.toggle('active', btn === tab);
                });
                card.querySelectorAll('.quick-preview-panel').forEach((panel) => {
                    panel.classList.toggle('is-active', panel.dataset.previewPanel === targetPanel);
                });
            };

            document.addEventListener('click', (event) => {
                const toggleBtn = event.target.closest('.view-toggle');
                if (toggleBtn) {
                    switchList(toggleBtn.dataset.target);
                    return;
                }

                const previewTab = event.target.closest('.preview-tab');
                if (previewTab) {
                    activatePreviewPanel(previewTab);
                    return;
                }

                if (event.target.closest('.sidebar-toggle')) {
                    const collapsed = shell.classList.contains('sidebar-collapsed');
                    setSidebarCollapsed(!collapsed);
                    return;
                }

                if (sidebarBackdrop && event.target === sidebarBackdrop) {
                    setSidebarCollapsed(true);
                    return;
                }

                const actionBtn = event.target.closest('.match-action');
                if (actionBtn) {
                    const card = actionBtn.closest('.match-card');
                    if (!card) return;
                    const matchId = card.dataset.matchId;
                    const section = card.dataset.section;
                    setActiveCard(matchId);
                    if (actionBtn.dataset.action === 'analysis') {
                        loadFullAnalysis(matchId);
                    } else {
                        loadQuickPreview(matchId, section);
                    }
                    autoCollapseSidebarForMobile();
                    return;
                }

                const card = event.target.closest('.match-card');
                if (card) {
                    const matchId = card.dataset.matchId;
                    const section = card.dataset.section;
                    setActiveCard(matchId);
                    loadQuickPreview(matchId, section);
                    autoCollapseSidebarForMobile();
                }
            });

            autoSelectFirstCard(state.activeList);
        })();
    </script>
</body>
</html>

